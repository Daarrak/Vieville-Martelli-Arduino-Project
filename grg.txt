//Libraries
#include <Pixy2.h>

//Variables
Pixy2 pixy;
int buzzer=11;
int trig=2;
int echo=8;
float lecture_echo;
int buzzer_val=0;
int verte=12;
int rouge=13;

// MOTEUR A
int ENA=9; // 9 pour sortie PWM
int IN1=4;
int IN2=5;

// MOTEUR B
int ENB=10; // 10 pour sortie PWM
int IN3=6;
int IN4=7;


void setup() {
 	Serial.begin(19200);
  pinMode(buzzer,OUTPUT);
  pinMode(trig,OUTPUT);
  pinMode(echo,INPUT);
  pinMode(ENA,OUTPUT);
  pinMode(ENB,OUTPUT);
  pinMode(IN1,OUTPUT);
  pinMode(IN2,OUTPUT);  
  pinMode(IN3,OUTPUT);
  pinMode(IN4,OUTPUT);
  pinMode(verte,OUTPUT);
  pinMode(rouge,OUTPUT);  

// Direction du Moteur droit
  digitalWrite(IN1,HIGH);  
  digitalWrite(IN2,LOW);

// Direction du Moteur gauche
  digitalWrite(IN3,HIGH);
  digitalWrite(IN4,LOW);

// Met les 2 moteurs à l'arrêt
  digitalWrite(ENA,0);
  digitalWrite(ENB,0);

  digitalWrite(verte,1);
  digitalWrite(rouge,0);

}

void loop() {
  testPixy();
}

void seek(){
  digitalWrite(trig,1);
  delayMicroseconds(10);
  digitalWrite(trig,0);
  lecture_echo=pulseIn(echo, 1)*0.017;
  Serial.println(lecture_echo);
  if(lecture_echo<15){
    digitalWrite(rouge,0);
    back();
  }
  else if(lecture_echo<20) {
    digitalWrite(verte,0);
    digitalWrite(rouge,1);
    stop();
    tone(buzzer, 1000, 100);
    delay(200);
    tone(buzzer, 3000, 100);
    delay(1800);
    turnRight();
    delay(500);
    stop();
    delay(800);
  }
  else {
    forward();
    digitalWrite(verte,1);
    digitalWrite(rouge,1);
  }
}

void testPixy() { 
  Serial.println(1);
 	//// Get blocks from Pixy2
 	pixy.ccc.getBlocks(true, 1);
  Serial.println(14);
 	if (pixy.ccc.numBlocks) {
    Serial.println(12);
    //pixy.setLamp(1,0); //Allume les 2 leds Pixy
 		if (pixy.ccc.blocks[0].m_x<150){
      // Tourne le véhicule à gauche pour centrer l'objet
      turnLeft();
    }
    else if (pixy.ccc.blocks[0].m_x>165){
      // Tourne le véhicule à droite pour centrer l'objet
      turnRight();
    } 
    else {
      //Le véhicule avance
      forward();
    }
 	}
  else {
    Serial.println(13);
    seek();
    //pixy.setLamp(0,0);
  }
}

 	

void stop(){
  digitalWrite(IN1,HIGH);  
  digitalWrite(IN2,LOW);
  digitalWrite(IN3,HIGH);
  digitalWrite(IN4,LOW);
  analogWrite(ENA,0);
  analogWrite(ENB,0);
}

void forward(){
  digitalWrite(IN1,HIGH);  
  digitalWrite(IN2,LOW);
  digitalWrite(IN3,HIGH);
  digitalWrite(IN4,LOW);
  analogWrite(ENA,115);
  analogWrite(ENB,100);
}

void turnRight(){
  digitalWrite(IN1,LOW);  
  digitalWrite(IN2,HIGH);
  digitalWrite(IN3,HIGH);
  digitalWrite(IN4,LOW);
  analogWrite(ENA,100);
  analogWrite(ENB,100);
}

void turnLeft(){
  digitalWrite(IN1,HIGH);  
  digitalWrite(IN2,LOW);
  digitalWrite(IN3,LOW);
  digitalWrite(IN4,HIGH);
  analogWrite(ENA,100);
  analogWrite(ENB,100);
}

void back(){
  digitalWrite(IN1,LOW);  
  digitalWrite(IN2,HIGH);
  digitalWrite(IN3,LOW);
  digitalWrite(IN4,HIGH);
  analogWrite(ENA,100);
  analogWrite(ENB,100);
}


